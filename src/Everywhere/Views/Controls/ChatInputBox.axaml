<ResourceDictionary
  xmlns="https://github.com/avaloniaui" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:ai="clr-namespace:Everywhere.AI" xmlns:be="clr-namespace:Everywhere.Behaviors"
  xmlns:chat="clr-namespace:Everywhere.Chat" xmlns:shadui="clr-namespace:ShadUI;assembly=ShadUI"
  xmlns:v="clr-namespace:Everywhere.Views" xmlns:vc="clr-namespace:Everywhere.ValueConverters">

  <ControlTheme
    x:Key="{x:Type v:ChatInputBox}"
    TargetType="v:ChatInputBox">

    <Style Selector="^ /template/ ToggleButton.Rounded">
      <Setter Property="Height" Value="30"/>
      <Setter Property="MinHeight" Value="30"/>
      <Setter Property="Padding" Value="8,0"/>
      <Setter Property="CornerRadius" Value="15"/>
    </Style>

    <Style Selector="^ /template/ MenuItem.Rounded">
      <Setter Property="Width" Value="30"/>
      <Setter Property="Height" Value="30"/>
      <Setter Property="Padding" Value="0"/>
      <Setter Property="CornerRadius" Value="15"/>
    </Style>

    <Style Selector="^ /template/ Button.Rounded">
      <Setter Property="Width" Value="30"/>
      <Setter Property="Height" Value="30"/>
      <Setter Property="Padding" Value="0"/>
      <Setter Property="CornerRadius" Value="15"/>
    </Style>

    <Style Selector="^ /template/ Button#PART_CancelButton:disabled">
      <Setter Property="IsVisible" Value="False"/>
    </Style>

    <Setter Property="Watermark" Value="{I18N {x:Static LocaleKey.ChatInputBox_Watermark}}"/>
    <Setter Property="FontSize" Value="14"/>
    <Setter Property="Padding" Value="6"/>
    <Setter Property="SelectionBrush" Value="{DynamicResource PrimaryColor}"/>
    <Setter Property="SelectionForegroundBrush" Value="{DynamicResource PrimaryForegroundColor}"/>
    <Setter Property="CaretBrush" Value="{DynamicResource ForegroundColor}"/>
    <Setter Property="MaxLines" Value="5"/>
    <Setter Property="Template">
      <ControlTemplate>
        <Grid
          ColumnDefinitions="*,Auto" RowDefinitions="*,Auto,Auto"
          RowSpacing="4">
          <ScrollViewer
            x:Name="PART_ScrollViewer" Grid.Row="0"
            Grid.Column="0" Grid.ColumnSpan="2"
            MinHeight="18.8" Margin="2,0"
            HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
            <Panel
              MinHeight="18.4" Background="Transparent"
              Cursor="IBeam">
              <TextBlock
                FontSize="{TemplateBinding FontSize}"
                Opacity="0.5"
                Text="{TemplateBinding Watermark}"
                TextAlignment="{TemplateBinding TextAlignment}"
                TextWrapping="{TemplateBinding TextWrapping}">
                <TextBlock.IsVisible>
                  <MultiBinding Converter="{x:Static BoolConverters.And}">
                    <Binding
                      Converter="{x:Static StringConverters.IsNullOrEmpty}"
                      ElementName="PART_TextPresenter" Path="PreeditText"/>
                    <Binding
                      Converter="{x:Static StringConverters.IsNullOrEmpty}"
                      Path="Text"
                      RelativeSource="{RelativeSource TemplatedParent}"/>
                  </MultiBinding>
                </TextBlock.IsVisible>
              </TextBlock>
              <TextPresenter
                x:Name="PART_TextPresenter"
                CaretBrush="{TemplateBinding CaretBrush}"
                CaretIndex="{TemplateBinding CaretIndex}"
                SelectionBrush="{TemplateBinding SelectionBrush}"
                SelectionEnd="{TemplateBinding SelectionEnd}"
                SelectionForegroundBrush="{TemplateBinding SelectionForegroundBrush}"
                SelectionStart="{TemplateBinding SelectionStart}"
                Text="{TemplateBinding Text, Mode=TwoWay}"
                TextAlignment="{TemplateBinding TextAlignment}"
                TextBlock.FontSize="{TemplateBinding FontSize}"
                TextBlock.Foreground="{TemplateBinding Foreground}"
                TextWrapping="{TemplateBinding TextWrapping}"/>
            </Panel>
          </ScrollViewer>

          <ScrollViewer
            Grid.Row="1" Grid.Column="0"
            Grid.ColumnSpan="2" MaxHeight="52"
            Margin="0,2" Padding="0"
            HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
            <Interaction.Behaviors>
              <be:AutoScrollBehavior/>
            </Interaction.Behaviors>

            <ItemsControl
              x:Name="PART_ChatAttachmentItemsControl"
              ItemsSource="{TemplateBinding ChatAttachmentItemsSource}">
              <ItemsControl.Styles>
                <Style Selector="Border.FocusedElement">
                  <Setter Property="BorderBrush" Value="{DynamicResource InfoColor}"/>
                  <Setter Property="BorderThickness" Value="1"/>
                  <Setter Property="Padding" Value="-1"/>
                </Style>
              </ItemsControl.Styles>

              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <WrapPanel
                    ItemSpacing="6" LineSpacing="4"/>
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>

              <ItemsControl.DataTemplates>
                <DataTemplate DataType="chat:ChatFileAttachment">
                  <Border
                    Height="24"
                    Background="{DynamicResource CardBackgroundColor}"
                    CornerRadius="4">

                    <StackPanel
                      Margin="6,0,4,0" Orientation="Horizontal"
                      Spacing="4">
                      <Image
                        MaxWidth="24" MaxHeight="24"
                        Margin="0,4" VerticalAlignment="Center"
                        IsVisible="{Binding IsImage}"
                        Source="{Binding Image}">
                        <ToolTip.Tip>
                          <Image Source="{Binding Image}"/>
                        </ToolTip.Tip>
                      </Image>

                      <StackPanel
                        Margin="6,0"
                        IsVisible="{Binding !IsImage}"
                        Orientation="Horizontal" Spacing="4"
                        ToolTip.Tip="{Binding FilePath}">
                        <LucideIcon
                          VerticalAlignment="Center"
                          Kind="{Binding Icon}"
                          Size="14"/>
                        <TextBlock
                          VerticalAlignment="Center" FontSize="12"
                          Text="{Binding HeaderKey^}"/>
                      </StackPanel>

                      <Button
                        Padding="1" VerticalAlignment="Center"
                        Background="Transparent" BorderThickness="0"
                        Command="{Binding $parent[v:ChatInputBox].RemoveAttachmentCommand}"
                        CommandParameter="{Binding}"
                        Focusable="False"
                        ToolTip.Tip="{I18N {x:Static LocaleKey.ChatAttachment_RemoveButton_ToolTip}}">
                        <LucideIcon
                          Foreground="{DynamicResource MutedColor}"
                          Kind="X" Size="12"/>
                      </Button>
                    </StackPanel>
                  </Border>
                </DataTemplate>

                <DataTemplate DataType="chat:ChatVisualElementAttachment">
                  <Border
                    Height="24"
                    Background="{DynamicResource CardBackgroundColor}"
                    Classes.FocusedElement="{Binding IsFocusedElement}"
                    CornerRadius="4">
                    <StackPanel
                      Margin="6,0,4,0" Orientation="Horizontal"
                      Spacing="4">
                      <LucideIcon
                        VerticalAlignment="Center"
                        Kind="{Binding Icon}"
                        Size="14"/>
                      <TextBlock
                        VerticalAlignment="Center" FontSize="12"
                        Text="{Binding HeaderKey^}"/>
                      <Button
                        Padding="1" VerticalAlignment="Center"
                        Background="Transparent" BorderThickness="0"
                        Command="{Binding $parent[v:ChatInputBox].RemoveAttachmentCommand}"
                        CommandParameter="{Binding}"
                        Focusable="False"
                        ToolTip.Tip="{I18N {x:Static LocaleKey.ChatAttachment_RemoveButton_ToolTip}}">
                        <LucideIcon
                          Foreground="{DynamicResource MutedColor}"
                          Kind="X" Size="12"/>
                      </Button>
                    </StackPanel>
                  </Border>
                </DataTemplate>

                <DataTemplate DataType="chat:ChatAttachment">
                  <Border
                    Height="24"
                    Background="{DynamicResource CardBackgroundColor}"
                    CornerRadius="4">
                    <StackPanel
                      Margin="6,0,4,0" Orientation="Horizontal"
                      Spacing="4">
                      <LucideIcon
                        VerticalAlignment="Center"
                        Kind="{Binding Icon}"
                        Size="14"/>
                      <TextBlock
                        VerticalAlignment="Center" FontSize="12"
                        Text="{Binding HeaderKey^}"/>
                      <Button
                        Padding="1" VerticalAlignment="Center"
                        Background="Transparent" BorderThickness="0"
                        Command="{Binding $parent[v:ChatInputBox].RemoveAttachmentCommand}"
                        CommandParameter="{Binding}"
                        Focusable="False"
                        ToolTip.Tip="{I18N {x:Static LocaleKey.ChatAttachment_RemoveButton_ToolTip}}">
                        <LucideIcon
                          Foreground="{DynamicResource MutedColor}"
                          Kind="X" Size="12"/>
                      </Button>
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ItemsControl.DataTemplates>
            </ItemsControl>
          </ScrollViewer>

          <StackPanel
            Grid.Row="2" Grid.Column="0"
            Orientation="Horizontal" Spacing="4">
            <Menu Focusable="False">
              <MenuItem
                Classes="Outline Rounded" Width="30"
                Height="30" Margin="0,0,4,0"
                shadui:MenuItemAssist.PopupMaxHeight="400" shadui:MenuItemAssist.PopupPlacement="Top"
                shadui:MenuItemAssist.PopupVerticalOffset="-4" Focusable="False"
                Grid.IsSharedSizeScope="True"
                ItemsSource="{TemplateBinding CustomAssistants, Mode=OneWay}"
                SelectedItem="{TemplateBinding SelectedCustomAssistant, Mode=OneWay}"
                ToolTip.Tip="{I18N {x:Static LocaleKey.ChatInputBox_CustomAssistantsMenuItem_ToolTip}}">

                <MenuItem.Header>
                  <v:IconPresenter
                    Width="30" Height="30"
                    FontSize="16"
                    Icon="{Binding SelectedCustomAssistant.Icon, RelativeSource={RelativeSource TemplatedParent}, FallbackValue={x:Null}}"
                    IconSize="16"/>
                </MenuItem.Header>

                <MenuItem.ItemContainerTheme>
                  <ControlTheme TargetType="MenuItem">
                    <Style Selector="^:pointerover">
                      <Setter Property="Background" Value="{DynamicResource CardBackgroundColor}"/>
                    </Style>

                    <Style Selector="^/template/ DockPanel.Selected">
                      <Style Selector="^ Border#SelectedBorder">
                        <Setter Property="Background" Value="{DynamicResource PrimaryColor}"/>
                      </Style>
                      <Style Selector="^ Border#ContainerBorder">
                        <Setter Property="Background" Value="{DynamicResource SecondaryCardBackgroundColor}"/>
                      </Style>
                    </Style>

                    <Style Selector="^/template/ shadui|Badge">
                      <Setter Property="Height" Value="18"/>
                      <Setter Property="CornerRadius" Value="4"/>
                      <Style Selector="^ LucideIcon">
                        <Setter Property="Size" Value="12"/>
                      </Style>
                    </Style>

                    <Setter Property="Focusable" Value="False"/>
                    <Setter Property="Command" Value="{Binding $parent[v:ChatInputBox].SetSelectedCustomAssistantCommand}"/>
                    <Setter Property="CommandParameter" Value="{Binding RelativeSource={RelativeSource Self}}"/>
                    <Setter Property="Template">
                      <ControlTemplate
                        x:DataType="ai:CustomAssistant" TargetType="MenuItem">
                        <DockPanel
                          Height="36" Margin="0,0,6,0"
                          Background="Transparent" LastChildFill="True">
                          <Classes.Selected>
                            <MultiBinding Converter="{x:Static vc:CommonConverters.AllEquals}">
                              <Binding Path="."/>
                              <Binding Path="$parent[v:ChatInputBox].SelectedCustomAssistant"/>
                            </MultiBinding>
                          </Classes.Selected>

                          <Border
                            x:Name="SelectedBorder" DockPanel.Dock="Left"
                            Width="4" Margin="4,2,2,2"
                            CornerRadius="2">
                          </Border>

                          <Border
                            x:Name="ContainerBorder" Margin="0,2,4,2"
                            Padding="4,2"
                            Background="{TemplateBinding Background}"
                            CornerRadius="4">
                            <Grid ColumnSpacing="4">
                              <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition/>
                                <ColumnDefinition
                                  Width="Auto" SharedSizeGroup="Badges"/>
                              </Grid.ColumnDefinitions>

                              <v:IconPresenter
                                Grid.Column="0" Width="20"
                                Height="20" VerticalAlignment="Center"
                                FontSize="14"
                                Icon="{Binding Icon}"
                                IconSize="14"/>
                              <TextBlock
                                Grid.Column="1" VerticalAlignment="Center"
                                Text="{Binding Name}"
                                TextTrimming="CharacterEllipsis"
                                ToolTip.Tip="{Binding Description}"/>

                              <StackPanel
                                Grid.Column="2" Margin="16,0,0,0"
                                HorizontalAlignment="Right" Orientation="Horizontal"
                                Spacing="2">
                                <shadui:Badge
                                  Background="Chocolate"
                                  IsVisible="{Binding IsImageInputSupported.ActualValue}"
                                  ToolTip.Tip="{I18N {x:Static LocaleKey.Settings_CustomAssistant_IsImageInputSupported_Header}}">
                                  <LucideIcon Kind="Eye"/>
                                </shadui:Badge>
                                <shadui:Badge
                                  Background="CadetBlue"
                                  IsVisible="{Binding IsFunctionCallingSupported.ActualValue}"
                                  ToolTip.Tip="{I18N {x:Static LocaleKey.Settings_CustomAssistant_IsFunctionCallingSupported_Header}}">
                                  <LucideIcon Kind="Hammer"/>
                                </shadui:Badge>
                                <shadui:Badge
                                  Background="ForestGreen"
                                  IsVisible="{Binding IsDeepThinkingSupported.ActualValue}"
                                  ToolTip.Tip="{I18N {x:Static LocaleKey.Settings_CustomAssistant_IsDeepThinkingSupported_Header}}">
                                  <LucideIcon Kind="Brain"/>
                                </shadui:Badge>
                                <shadui:Badge
                                  Background="MediumSlateBlue"
                                  IsVisible="{Binding MaxTokens.ActualValue}"
                                  ToolTip.Tip="{I18N {x:Static LocaleKey.Settings_CustomAssistant_MaxTokens_Header}}">
                                  <TextBlock
                                    FontSize="12"
                                    Text="{Binding MaxTokens.ActualValue, Converter={x:Static vc:TokenCountHumanizationConverter.Shared}}"/>
                                </shadui:Badge>
                              </StackPanel>
                            </Grid>
                          </Border>
                        </DockPanel>
                      </ControlTemplate>
                    </Setter>
                  </ControlTheme>
                </MenuItem.ItemContainerTheme>
              </MenuItem>

              <MenuItem
                Classes="Outline Rounded" Width="30"
                Height="30" shadui:MenuItemAssist.PopupPlacement="Top"
                shadui:MenuItemAssist.PopupVerticalOffset="-4"
                ItemsSource="{TemplateBinding AddChatAttachmentMenuItems}"
                ToolTip.Tip="{I18N {x:Static LocaleKey.ChatInputBox_AddAttachmentMenuItem_ToolTip}}">
                <shadui:MenuItemAssist.Label>
                  <TextBlock>
                    <Run Text="{I18N {x:Static LocaleKey.ChatInputBox_AddAttachmentMenuItem_Header}}"/>
                    <Run Text=" ("/>
                    <Run Text="{Binding $parent[v:ChatInputBox].ChatAttachmentItemsSource.Count, FallbackValue=0}"/>
                    <Run Text="/"/>
                    <Run Text="{Binding $parent[v:ChatInputBox].MaxChatAttachmentCount}"/>
                    <Run Text=")"/>
                  </TextBlock>
                </shadui:MenuItemAssist.Label>

                <MenuItem.Header>
                  <LucideIcon
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    Kind="Paperclip" Size="16"/>
                </MenuItem.Header>
              </MenuItem>
            </Menu>

            <ToggleButton
              Classes="Outline Rounded" Width="30"
              Height="30" Focusable="False"
              IsChecked="{Binding IsImageEnabled, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay}"
              IsVisible="{TemplateBinding IsImageSupported}"
              ToolTip.Tip="{I18N {x:Static LocaleKey.ChatInputBox_ImageButton_ToolTip}}">
              <LucideIcon
                Kind="Image" Size="16"/>
            </ToggleButton>

            <ToggleButton
              Classes="Outline Rounded" Width="30"
              Height="30" Focusable="False"
              IsChecked="{Binding IsToolCallEnabled, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay}"
              IsVisible="{TemplateBinding IsToolCallSupported}"
              ToolTip.Tip="{I18N {x:Static LocaleKey.ChatInputBox_ToolCallButton_ToolTip}}">
              <LucideIcon
                Margin="-1,-1,1,1" Kind="Hammer"
                Size="16"/>
            </ToggleButton>

            <Menu Focusable="False">
              <MenuItem
                Classes="Outline Rounded" Width="30"
                Height="30" shadui:MenuItemAssist.PopupPlacement="Top"
                shadui:MenuItemAssist.PopupVerticalOffset="-4"
                ItemsSource="{TemplateBinding SettingsMenuItems}"
                ToolTip.Tip="{I18N {x:Static LocaleKey.ChatInputBox_SettingsMenuItem_ToolTip}}">
                <MenuItem.Header>
                  <LucideIcon
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    Kind="Settings" Size="16"/>
                </MenuItem.Header>
              </MenuItem>
            </Menu>
          </StackPanel>

          <StackPanel
            Grid.Row="2" Grid.Column="1"
            Margin="8,0,0,0" Orientation="Horizontal"
            Spacing="4">
            <Button
              x:Name="PART_SendButton" Classes="Primary Rounded"
              IsVisible="{Binding !IsVisible, ElementName=PART_CancelButton}"
              ToolTip.Tip="{I18N {x:Static LocaleKey.ChatInputBox_SendButton_ToolTip}}">
              <Button.IsEnabled>
                <MultiBinding Converter="{x:Static BoolConverters.And}">
                  <Binding
                    Path="IsSendButtonEnabled"
                    RelativeSource="{RelativeSource TemplatedParent}"/>
                  <Binding
                    Converter="{x:Static StringConverters.IsNotNullOrEmpty}"
                    Path="Text"
                    RelativeSource="{RelativeSource TemplatedParent}"/>
                </MultiBinding>
              </Button.IsEnabled>

              <LucideIcon
                Margin="-1,1,1,-1" Kind="Send"
                Size="16"/>
            </Button>

            <Button
              x:Name="PART_CancelButton" Classes="Primary Rounded"
              Command="{TemplateBinding CancelCommand}"
              Focusable="False"
              ToolTip.Tip="{I18N {x:Static LocaleKey.ChatInputBox_CancelButton_ToolTip}}">
              <Border
                Width="12" Height="12"
                Background="{DynamicResource ForegroundColor}"
                CornerRadius="1"/>
            </Button>
          </StackPanel>
        </Grid>
      </ControlTemplate>
    </Setter>
  </ControlTheme>
</ResourceDictionary>